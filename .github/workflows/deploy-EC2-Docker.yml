name: "CI/CD: Build & Deploy to EC2"

on:
  push:
    branches: [feature/CICD-#1]

jobs:
  build:
    name: ðŸ›  Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Generate .env from Secrets
        run: |
          cat <<EOF > .env
          PORT=${{ secrets.ENV_PORT }}
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          IMAGE_NAME=${{ secrets.ENV_IMAGE_NAME }}
          EOF

      - name: Run build.sh
        run: |
          chmod +x ./scripts/build.sh
          ./scripts/build.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: push image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/antmen:latest

  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code (for docker-compose.yml & .env)
        uses: actions/checkout@v4

      - name: Copy docker-compose.yml 
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: |
            docker-compose.yml
          target: ~/apps/server

      - name: SSH into EC2 and restart container
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # âœ… Docker ì„¤ì¹˜ (ì—†ìœ¼ë©´ ì„¤ì¹˜)
            if ! command -v docker &> /dev/null; then
              echo "ðŸš€ Docker not found. Installing..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              newgrp docker
            fi

            # âœ… Docker Compose Plugin ì„¤ì¹˜ (v2 ì´ìƒ)
            if ! docker compose version &> /dev/null; then
              echo "ðŸš€ Docker Compose plugin not found. Installing..."
              mkdir -p ~/.docker/cli-plugins
              curl -SL https://github.com/docker/compose/releases/download/v2.24.1/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
              chmod +x ~/.docker/cli-plugins/docker-compose
            fi

            cd ~/apps/server
            export PORT=${{ secrets.ENV_PORT }}
            export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            export IMAGE_NAME=${{ secrets.ENV_IMAGE_NAME }}
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_TOKEN }}
            docker compose pull
            docker compose down
            docker compose up -d

